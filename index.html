<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg1:#0b1020;
  --bg2:#1f3c88;
  --card:rgba(30,30,30,.75);
  --accent:#4caf50;
  --muted:#aaa;
}
*{
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
body{
  margin:0;
  font-family:Arial;
  color:#fff;
  background:
    radial-gradient(circle at top,var(--bg2),var(--bg1) 60%),
    linear-gradient(135deg,#121212,#1a1a1a);
}
.app{
  max-width:420px;
  height:100vh;
  margin:auto;
  display:flex;
  flex-direction:column;
  padding:8px;
}
.card{
  background:var(--card);
  border-radius:12px;
  padding:8px;
  margin-bottom:6px;
}
h3{text-align:center;margin:6px 0}
.row{display:flex;justify-content:space-between;align-items:center}
.item{
  padding:8px;
  border-radius:8px;
  cursor:pointer;
}
.item:hover{background:rgba(255,255,255,.08)}
.small{font-size:11px;color:var(--muted)}
.online{color:#4caf50;font-size:11px}
.offline{color:#aaa;font-size:11px}
.dots{
  font-size:22px;
  font-weight:bold;
  padding:0 8px;
  cursor:pointer;
}
.messages{flex:1;overflow-y:auto}
.msg{
  margin:4px 0;
  padding:8px;
  border-radius:10px;
  background:#2a2a2a;
}
.mine{background:#4caf50}
.send{display:flex;gap:6px}
input,button{border:none;border-radius:10px;padding:10px}
input{flex:1}
button{background:#4caf50;color:white}
</style>
</head>

<body>
<div class="app">

<h3>ğŸ’¬ Ege Chat</h3>

<input id="username" placeholder="KullanÄ±cÄ± adÄ±n">

<div class="card">
  <input id="newGroup" placeholder="â• Grup adÄ±">
  <button onclick="createGroup()">Grup OluÅŸtur</button>
</div>

<div class="card" id="groups"><b>ğŸ” GruplarÄ±m</b></div>
<div class="card" id="users"><b>ğŸ‘¤ KiÅŸiler</b></div>

<div class="small" id="roomInfo">Sohbet seÃ§</div>
<div class="messages" id="messages"></div>

<div class="send">
  <input id="msg" placeholder="Mesaj yaz" disabled>
  <button onclick="send()">GÃ¶nder</button>
</div>

</div>

<script>
/* ğŸ” SÃœPER ADMIN (kÃ¼Ã§Ã¼k harf!) */
const SUPER_ADMIN = "ege";

/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
  authDomain: "chat-lobby-fa938.firebaseapp.com",
  databaseURL: "https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-lobby-fa938"
});
const db = firebase.database();

/* STATE */
let username = localStorage.getItem("ege_user") || "";
let chatPath = null;
let msgRef = null;

/* ELEMENTS */
const uInput = document.getElementById("username");
const groupsDiv = document.getElementById("groups");
const usersDiv = document.getElementById("users");
const messages = document.getElementById("messages");
const msgInput = document.getElementById("msg");
const roomInfo = document.getElementById("roomInfo");

/* LOGIN */
function login(){
  db.ref("banned/"+username.toLowerCase()).once("value",snap=>{
    if(snap.exists()){
      alert("â›” Bu hesap kapatÄ±ldÄ±");
      localStorage.removeItem("ege_user");
      location.reload();
    }else{
      db.ref("users/"+username).set(true);
      setOnline();
    }
  });
}
if(username){
  uInput.value=username;
  uInput.style.display="none";
  login();
}
uInput.onchange=()=>{
  username=uInput.value.trim();
  if(!username) return;
  localStorage.setItem("ege_user",username);
  uInput.style.display="none";
  login();
};

/* ONLINE */
function setOnline(){
  const r=db.ref("status/"+username);
  r.set({online:true,last:Date.now()});
  r.onDisconnect().set({online:false,last:Date.now()});
}

/* CREATE GROUP */
function createGroup(){
  const g=document.getElementById("newGroup").value.trim();
  if(!g) return;
  db.ref("groups/"+g).set({
    owner:username,
    members:{[username]:true}
  });
}

/* GROUP LIST */
db.ref("groups").on("value",snap=>{
  let h="<b>ğŸ” GruplarÄ±m</b>";
  snap.forEach(g=>{
    if(g.val().members && g.val().members[username]){
      h+=`
      <div class="item row"
        ontouchstart="openGroup('${g.key}')"
        onclick="openGroup('${g.key}')">
        <span>ğŸ”’ ${g.key}</span>
        <span class="dots"
          ontouchstart="event.stopPropagation();groupMenu('${g.key}')"
          onclick="event.stopPropagation();groupMenu('${g.key}')">â‹®</span>
      </div>`;
    }
  });
  groupsDiv.innerHTML=h;
});

/* GROUP MENU */
function groupMenu(group){
  db.ref("groups/"+group).once("value",snap=>{
    const d=snap.val();
    if(!d || d.owner!==username) return;
    const a=prompt("ADMIN\n1=Ãœye ekle\n2=Ãœye Ã§Ä±kar");
    if(a==="1"){
      const u=prompt("KullanÄ±cÄ±:");
      if(u) db.ref("groups/"+group+"/members/"+u).set(true);
    }
    if(a==="2"){
      const u=prompt("KullanÄ±cÄ±:");
      if(u && u!==username)
        db.ref("groups/"+group+"/members/"+u).remove();
    }
  });
}

/* USERS + ADMIN â‹® */
db.ref("users").on("value",snap=>{
  let h="<b>ğŸ‘¤ KiÅŸiler</b>";
  snap.forEach(u=>{
    if(u.key!==username){
      db.ref("status/"+u.key).once("value",st=>{
        const s=st.val();
        const info=s&&s.online
          ? `<span class="online">ğŸŸ¢ online</span>`
          : `<span class="offline">ğŸ•“ bilinmiyor</span>`;
        h+=`
        <div class="item row">
          <span
            ontouchstart="openDM('${u.key}')"
            onclick="openDM('${u.key}')">
            ğŸ”’ ${u.key}<br>${info}
          </span>
          ${username.toLowerCase()===SUPER_ADMIN
            ? `<span class="dots"
                ontouchstart="userMenu('${u.key}')"
                onclick="userMenu('${u.key}')">â‹®</span>`
            : ``}
        </div>`;
        usersDiv.innerHTML=h;
      });
    }
  });
});

/* USER MENU (BAN) */
function userMenu(target){
  if(username.toLowerCase()!==SUPER_ADMIN) return;
  if(!confirm(target+" hesabÄ± kapatÄ±lsÄ±n mÄ±?")) return;

  db.ref("banned/"+target.toLowerCase()).set(true);
  db.ref("users/"+target).remove();
  db.ref("status/"+target).remove();

  db.ref("groups").once("value",snap=>{
    snap.forEach(g=>{
      if(g.val().members && g.val().members[target]){
        db.ref("groups/"+g.key+"/members/"+target).remove();
      }
    });
  });
}

/* OPEN DM */
function openDM(u){
  const id=["dm",username,u].sort().join("_");
  roomInfo.innerText="ğŸ”’ "+u;
  chatPath="privateMessages/"+id;
  load();
}

/* OPEN GROUP */
function openGroup(g){
  roomInfo.innerText="ğŸ” "+g;
  chatPath="groupMessages/"+g;
  load();
}

/* LOAD MSG */
function load(){
  messages.innerHTML="";
  msgInput.disabled=false;
  if(msgRef) msgRef.off();
  msgRef=db.ref(chatPath);
  msgRef.limitToLast(50).on("child_added",s=>{
    const d=s.val();
    const div=document.createElement("div");
    div.className="msg"+(d.user===username?" mine":"");
    div.innerText=d.user+": "+d.text;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
  });
}

/* SEND */
function send(){
  if(!msgInput.value||!chatPath) return;
  db.ref(chatPath).push({
    user:username,
    text:msgInput.value,
    time:Date.now()
  });
  msgInput.value="";
}
</script>
</body>
</html>