<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#121212;color:white;font-family:Arial}
.chat{max-width:420px;height:100vh;margin:auto;background:#1e1e1e;display:flex;flex-direction:column;padding:10px}
h3{text-align:center;margin:5px 0}
.users{background:#2a2a2a;padding:6px;border-radius:6px;font-size:13px}
.user{padding:5px;cursor:pointer}
.user:hover{background:#3a3a3a}
.room{text-align:center;font-size:13px;color:#ccc;margin:5px 0}
.messages{flex:1;overflow-y:auto;margin:5px 0}
.msg{background:#333;padding:8px;border-radius:8px;margin:4px 0}
.send{display:flex;gap:5px}
input,button{padding:10px;border:none;border-radius:8px}
input{flex:1}
button{background:#4caf50;color:white}
#username{margin-bottom:5px}
</style>
</head>

<body>

<div class="chat">
  <h3>üí¨ Ege Chat</h3>

  <input id="username" placeholder="Kullanƒ±cƒ± adƒ±n">

  <div class="users" id="users"><b>Ki≈üiler</b></div>

  <div class="room" id="roomName">üåç Genel Sohbet</div>

  <div class="messages" id="messages"></div>

  <div class="send">
    <input id="message" placeholder="Mesaj yaz">
    <button onclick="sendMessage()">G√∂nder</button>
  </div>
</div>

<script>
/* üî• FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
  authDomain: "chat-lobby-fa938.firebaseapp.com",
  databaseURL: "https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-lobby-fa938",
  storageBucket: "chat-lobby-fa938.firebasestorage.app",
  messagingSenderId: "436067349066",
  appId: "1:436067349066:web:65f19c754697b6f84d6cb3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ELEMENTLER */
const userInput = document.getElementById("username");
const usersDiv = document.getElementById("users");
const messages = document.getElementById("messages");
const msgInput = document.getElementById("message");
const roomName = document.getElementById("roomName");

/* KULLANICI */
let username = localStorage.getItem("egechat_username") || "";
let currentChat = "public";
let msgRef;

/* OTOMATƒ∞K Gƒ∞Rƒ∞≈û */
if(username){
  userInput.value = username;
  userInput.style.display = "none";
  registerUser();
  loadMessages();
}

/* ƒ∞LK Gƒ∞Rƒ∞≈û */
userInput.addEventListener("change",()=>{
  username = userInput.value.trim();
  if(!username) return;
  localStorage.setItem("egechat_username",username);
  userInput.style.display="none";
  registerUser();
  loadMessages();
});

/* KULLANICIYI KAYDET */
function registerUser(){
  db.ref("users/"+username).set(true);
}

/* Kƒ∞≈ûƒ∞LER Lƒ∞STESƒ∞ */
db.ref("users").on("value",snap=>{
  let html="<b>Ki≈üiler</b>";
  snap.forEach(u=>{
    if(u.key!==username){
      html+=`<div class="user" onclick="openPrivate('${u.key}')">üë§ ${u.key}</div>`;
    }
  });
  usersDiv.innerHTML=html;
});

/* √ñZEL SOHBET A√á */
function openPrivate(other){
  currentChat=[username,other].sort().join("|");
  roomName.innerText="üîí "+other+" ile √∂zel sohbet";
  messages.innerHTML="";
  loadMessages();
}

/* GENEL SOHBETE D√ñN */
roomName.onclick=()=>{
  currentChat="public";
  roomName.innerText="üåç Genel Sohbet";
  messages.innerHTML="";
  loadMessages();
}

/* MESAJLARI Y√úKLE */
function loadMessages(){
  if(msgRef) msgRef.off();

  msgRef = currentChat==="public"
    ? db.ref("messages")
    : db.ref("privateMessages/"+currentChat);

  msgRef.limitToLast(50).on("child_added",snap=>{
    const d=snap.val();
    const div=document.createElement("div");
    div.className="msg";
    div.innerText=d.user+": "+d.text;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
  });
}

/* MESAJ G√ñNDER */
function sendMessage(){
  if(!msgInput.value.trim()) return;

  const ref = currentChat==="public"
    ? db.ref("messages")
    : db.ref("privateMessages/"+currentChat);

  ref.push({
    user:username,
    text:msgInput.value,
    time:Date.now()
  });

  msgInput.value="";
}
</script>

</body>
</html>