<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>

<!-- ğŸ“± iOS FULLSCREEN -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ege Chat">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#121212;
  color:white;
  font-family:Arial;
}
.chat{
  max-width:420px;
  height:100vh;
  margin:auto;
  background:#1e1e1e;
  display:flex;
  flex-direction:column;
  padding:10px;
}
h3{text-align:center;margin:5px 0}
.status{font-size:12px;color:#aaa;white-space:pre-line}
.users{
  background:#2a2a2a;
  padding:5px;
  border-radius:6px;
  font-size:13px;
  margin-bottom:5px;
}
.user{
  padding:4px;
  cursor:pointer;
}
.user:hover{background:#3a3a3a}
.messages{flex:1;overflow-y:auto;margin:10px 0}
.msg{background:#333;padding:8px;border-radius:8px;margin:4px 0}
.send{display:flex;gap:5px}
input,button{padding:10px;border:none;border-radius:8px}
input{flex:1}
button{background:#4caf50;color:white}
.room{
  text-align:center;
  font-size:13px;
  color:#ccc;
}
</style>
</head>

<body>

<audio id="notifySound" src="https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3"></audio>

<div class="chat">
  <h3>ğŸ’¬ Ege Chat</h3>

  <div class="status" id="onlineStatus"></div>
  <div class="status" id="typingStatus"></div>

  <input id="username" placeholder="KullanÄ±cÄ± adÄ±n">
  <div class="users" id="users"></div>

  <div class="room" id="roomName">ğŸŒ Genel Sohbet</div>
  <div class="messages" id="messages"></div>

  <div class="send">
    <input id="message" placeholder="Mesaj yaz">
    <button onclick="sendMessage()">GÃ¶nder</button>
  </div>
</div>

<script>
/* ğŸ”¥ FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
  authDomain: "chat-lobby-fa938.firebaseapp.com",
  databaseURL: "https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-lobby-fa938",
  storageBucket: "chat-lobby-fa938.firebasestorage.app",
  messagingSenderId: "436067349066",
  appId: "1:436067349066:web:65f19c754697b6f84d6cb3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ğŸ¯ ELEMENTLER */
const userInput = document.getElementById("username");
const msgInput = document.getElementById("message");
const messages = document.getElementById("messages");
const onlineStatus = document.getElementById("onlineStatus");
const typingStatus = document.getElementById("typingStatus");
const usersDiv = document.getElementById("users");
const roomName = document.getElementById("roomName");
const sound = document.getElementById("notifySound");

/* ğŸ‘¤ KULLANICI */
let username = localStorage.getItem("egechat_username") || "";
let currentChat = "public";
let msgRef;

/* OTOMATÄ°K GÄ°RÄ°Å */
if(username){
  userInput.value = username;
  userInput.style.display = "none";
  setOnline();
  loadMessages();
}

/* Ä°LK KEZ GÄ°RÄ°Å */
userInput.addEventListener("change", () => {
  username = userInput.value.trim();
  if(!username) return;
  localStorage.setItem("egechat_username", username);
  userInput.style.display = "none";
  setOnline();
  loadMessages();
});

/* ğŸŸ¢ ONLINE + LAST SEEN */
function setOnline(){
  db.ref("users/" + username).set(true);
  const ref = db.ref("status/" + username);
  ref.set({online:true,lastSeen:Date.now()});
  ref.onDisconnect().set({online:false,lastSeen:Date.now()});
}

/* ğŸ‘¥ KÄ°ÅÄ°LER */
db.ref("users").on("value", snap=>{
  let html="<b>KiÅŸiler</b>";
  snap.forEach(u=>{
    if(u.key!==username){
      html+=`<div class="user" onclick="openPrivate('${u.key}')">ğŸ‘¤ ${u.key}</div>`;
    }
  });
  usersDiv.innerHTML=html;
});

/* ğŸ“© Ã–ZEL SOHBET */
function openPrivate(other){
  currentChat=[username,other].sort().join("|");
  roomName.innerText="ğŸ”’ "+other+" ile Ã¶zel sohbet";
  messages.innerHTML="";
  loadMessages();
}

/* ğŸŒ GENEL */
roomName.onclick=()=>{
  currentChat="public";
  roomName.innerText="ğŸŒ Genel Sohbet";
  messages.innerHTML="";
  loadMessages();
}

/* ğŸ“¥ MESAJLAR */
function loadMessages(){
  if(msgRef) msgRef.off();

  msgRef=currentChat==="public"
    ? db.ref("messages")
    : db.ref("privateMessages/"+currentChat);

  msgRef.limitToLast(50).on("child_added", snap=>{
    const d=snap.val();
    const div=document.createElement("div");
    div.className="msg";
    div.innerText=d.user+": "+d.text;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
    if(d.user!==username) sound.play().catch(()=>{});
  });
}

/* ğŸ“¤ GÃ–NDER */
function sendMessage(){
  if(!msgInput.value.trim()) return;
  const ref=currentChat==="public"
    ? db.ref("messages")
    : db.ref("privateMessages/"+currentChat);
  ref.push({user:username,text:msgInput.value,time:Date.now()});
  msgInput.value="";
}

/* âœï¸ YAZIYOR */
msgInput.addEventListener("input",()=>{
  if(!username) return;
  db.ref("typing/"+username).set(true);
  clearTimeout(window.t);
  window.t=setTimeout(()=>db.ref("typing/"+username).set(false),1000);
});

db.ref("typing").on("value", snap=>{
  let arr=[];
  snap.forEach(u=>{
    if(u.val() && u.key!==username) arr.push(u.key);
  });
  typingStatus.innerText=arr.length?"âœï¸ "+arr.join(", ")+" yazÄ±yor...":"";
});

/* ğŸ‘¥ DURUM */
db.ref("status").on("value", snap=>{
  let txt="";
  snap.forEach(u=>{
    const d=u.val();
    txt+=d.online
      ? "ğŸŸ¢ "+u.key+" online\n"
      : "âš« "+u.key+" son: "+timeAgo(d.lastSeen)+"\n";
  });
  onlineStatus.innerText=txt;
});

/* â±ï¸ ZAMAN */
function timeAgo(t){
  const s=Math.floor((Date.now()-t)/1000);
  if(s<60) return s+" sn";
  if(s<3600) return Math.floor(s/60)+" dk";
  if(s<86400) return Math.floor(s/3600)+" sa";
  return Math.floor(s/86400)+" g";
}
</script>
</body>
</html>