<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>

<!-- üì± iOS FULLSCREEN -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ege Chat">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#121212;
  color:white;
  font-family:Arial;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.chat{
  width:100%;
  max-width:420px;
  height:100vh;
  background:#1e1e1e;
  display:flex;
  flex-direction:column;
  padding:10px;
}
h3{text-align:center;margin:5px 0}
.status{font-size:12px;color:#aaa;white-space:pre-line}
.messages{flex:1;overflow-y:auto;margin:10px 0}
.msg{background:#333;padding:8px;border-radius:8px;margin:4px 0}
.send{display:flex;gap:5px}
input,button{padding:10px;border:none;border-radius:8px}
input{flex:1}
button{background:#4caf50;color:white}
#username{margin-bottom:5px}
</style>
</head>

<body>

<audio id="notifySound" src="https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3"></audio>

<div class="chat">
  <h3>üí¨ Ege Chat</h3>

  <div class="status" id="onlineStatus"></div>
  <div class="status" id="typingStatus"></div>

  <input id="username" placeholder="Kullanƒ±cƒ± adƒ±n">
  <div class="messages" id="messages"></div>

  <div class="send">
    <input id="message" placeholder="Mesaj yaz">
    <button onclick="sendMessage()">G√∂nder</button>
  </div>
</div>

<script>
/* üî• FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
  authDomain: "chat-lobby-fa938.firebaseapp.com",
  databaseURL: "https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-lobby-fa938",
  storageBucket: "chat-lobby-fa938.firebasestorage.app",
  messagingSenderId: "436067349066",
  appId: "1:436067349066:web:65f19c754697b6f84d6cb3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* üéØ ELEMENTLER */
const userInput = document.getElementById("username");
const msgInput = document.getElementById("message");
const messages = document.getElementById("messages");
const onlineStatus = document.getElementById("onlineStatus");
const typingStatus = document.getElementById("typingStatus");
const sound = document.getElementById("notifySound");

let username = localStorage.getItem("egechat_username") || "";

/* üë§ KULLANICI ADI OTOMATƒ∞K */
if(username){
  userInput.value = username;
  userInput.style.display = "none";
  setOnline(true);
}

/* üë§ ƒ∞LK KEZ Gƒ∞Rƒ∞≈û */
userInput.addEventListener("change", () => {
  username = userInput.value.trim();
  if(!username) return;
  localStorage.setItem("egechat_username", username);
  userInput.style.display = "none";
  setOnline(true);
});

/* üü¢ ONLINE + SON G√ñR√úLME */
function setOnline(state){
  const ref = db.ref("status/" + username);
  ref.set({ online:true, lastSeen:Date.now() });
  ref.onDisconnect().set({ online:false, lastSeen:Date.now() });
}

/* ‚úçÔ∏è YAZIYOR */
msgInput.addEventListener("input", () => {
  if(!username) return;
  db.ref("typing/" + username).set(true);
  clearTimeout(window.t);
  window.t = setTimeout(()=>{
    db.ref("typing/" + username).set(false);
  },1000);
});

/* üì© MESAJ */
function sendMessage(){
  if(!msgInput.value.trim()) return;
  db.ref("messages").push({
    user:username,
    text:msgInput.value,
    time:Date.now()
  });
  db.ref("typing/" + username).set(false);
  msgInput.value="";
}

/* üì• MESAJ + üîî */
db.ref("messages").on("child_added", snap=>{
  const d=snap.val();
  const div=document.createElement("div");
  div.className="msg";
  div.innerText=d.user+": "+d.text;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
  if(d.user!==username) sound.play().catch(()=>{});
});

/* üë• DURUM */
db.ref("status").on("value", snap=>{
  let txt="";
  snap.forEach(u=>{
    const d=u.val();
    txt+=d.online
      ? "üü¢ "+u.key+" online\n"
      : "‚ö´ "+u.key+" son: "+timeAgo(d.lastSeen)+"\n";
  });
  onlineStatus.innerText=txt;
});

/* ‚úçÔ∏è YAZIYOR G√ñSTER */
db.ref("typing").on("value", snap=>{
  let arr=[];
  snap.forEach(u=>{
    if(u.val() && u.key!==username) arr.push(u.key);
  });
  typingStatus.innerText=arr.length
    ? "‚úçÔ∏è "+arr.join(", ")+" yazƒ±yor..."
    : "";
});

/* ‚è±Ô∏è ZAMAN */
function timeAgo(t){
  const s=Math.floor((Date.now()-t)/1000);
  if(s<60) return s+" sn";
  if(s<3600) return Math.floor(s/60)+" dk";
  if(s<86400) return Math.floor(s/3600)+" sa";
  return Math.floor(s/86400)+" g";
}
</script>
</body>
</html>