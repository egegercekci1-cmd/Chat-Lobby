<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ===== THEME ===== */
:root{
  --bg1:#0b1020;
  --bg2:#1f3c88;
  --card:rgba(30,30,30,0.75);
  --accent:#4caf50;
  --text:#fff;
  --muted:#aaa;
}

/* ===== BACKGROUND ===== */
body{
  margin:0;
  font-family:Arial;
  color:var(--text);
  background:
    radial-gradient(circle at top, var(--bg2), var(--bg1) 60%),
    linear-gradient(135deg,#121212,#1a1a1a);
  min-height:100vh;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:radial-gradient(#ffffff08 1px,transparent 1px);
  background-size:20px 20px;
  pointer-events:none;
}

/* ===== APP ===== */
.app{
  max-width:420px;
  height:100vh;
  margin:auto;
  display:flex;
  flex-direction:column;
  padding:8px;
  backdrop-filter:blur(12px);
}

/* ===== UI ===== */
h3{text-align:center;margin:6px 0}
.card{
  background:var(--card);
  border-radius:10px;
  padding:8px;
  margin-bottom:6px;
  border:1px solid rgba(255,255,255,0.08);
}
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.item{
  padding:6px;
  border-radius:6px;
  cursor:pointer;
}
.item:hover{background:rgba(255,255,255,0.08)}
.small{font-size:11px;color:var(--muted)}
.online{color:var(--accent);font-size:11px}
.offline{color:var(--muted);font-size:11px}

/* ===== CHAT ===== */
.messages{
  flex:1;
  overflow-y:auto;
}
.msg{
  margin:4px 0;
  padding:8px;
  border-radius:10px;
  background:linear-gradient(135deg,#2a2a2a,#1f1f1f);
  box-shadow:0 4px 10px rgba(0,0,0,.4);
}
.mine{
  background:linear-gradient(135deg,#4caf50,#2e7d32);
}
.send{
  display:flex;
  gap:6px;
}
input,button{
  border:none;
  border-radius:10px;
  padding:10px;
}
input{flex:1}
button{
  background:var(--accent);
  color:white;
}

/* ===== DOTS ===== */
.dots{
  font-size:20px;
  color:#ccc;
  cursor:pointer;
}
.dots:hover{color:white}
</style>
</head>

<body>
<div class="app">

<h3>ğŸ’¬ Ege Chat</h3>

<input id="username" placeholder="KullanÄ±cÄ± adÄ±n">

<div class="card">
  <input id="newGroup" placeholder="â• Grup adÄ±">
  <button onclick="createGroup()">Grup OluÅŸtur</button>
</div>

<div class="card" id="groups"><b>ğŸ” GruplarÄ±m</b></div>
<div class="card" id="users"><b>ğŸ‘¤ KiÅŸiler</b></div>

<div class="small" id="roomInfo">Sohbet seÃ§</div>

<div class="messages" id="messages"></div>

<div class="send">
  <input id="msg" placeholder="Mesaj yaz" disabled>
  <button onclick="send()">GÃ¶nder</button>
</div>

</div>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
  authDomain: "chat-lobby-fa938.firebaseapp.com",
  databaseURL: "https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-lobby-fa938"
});
const db=firebase.database();

/* ===== STATE ===== */
let username=localStorage.getItem("ege_user")||"";
let chatPath=null;
let msgRef=null;

/* ===== ELEMENTS ===== */
const uInput=document.getElementById("username");
const groupsDiv=document.getElementById("groups");
const usersDiv=document.getElementById("users");
const messages=document.getElementById("messages");
const msgInput=document.getElementById("msg");
const roomInfo=document.getElementById("roomInfo");

/* ===== TIME ===== */
function ago(t){
  if(!t) return "bilinmiyor";
  const d=Math.floor((Date.now()-t)/1000);
  if(d<60) return "az Ã¶nce";
  if(d<3600) return Math.floor(d/60)+" dk Ã¶nce";
  return Math.floor(d/3600)+" sa Ã¶nce";
}

/* ===== ONLINE ===== */
function setOnline(){
  const r=db.ref("status/"+username);
  r.set({online:true,last:Date.now()});
  r.onDisconnect().set({online:false,last:Date.now()});
}

/* ===== LOGIN ===== */
if(username){
  uInput.value=username;
  uInput.style.display="none";
  db.ref("users/"+username).set(true);
  setOnline();
}
uInput.onchange=()=>{
  username=uInput.value.trim();
  if(!username) return;
  localStorage.setItem("ege_user",username);
  uInput.style.display="none";
  db.ref("users/"+username).set(true);
  setOnline();
};

/* ===== CREATE GROUP ===== */
function createGroup(){
  const g=document.getElementById("newGroup").value.trim();
  if(!g) return;
  db.ref("groups/"+g).set({
    owner:username,
    members:{[username]:true}
  });
  document.getElementById("newGroup").value="";
}

/* ===== GROUP LIST ===== */
db.ref("groups").on("value",snap=>{
  let h="<b>ğŸ” GruplarÄ±m</b>";
  snap.forEach(g=>{
    if(g.val().members && g.val().members[username]){
      h+=`
      <div class="item row">
        <span onclick="openGroup('${g.key}')">ğŸ”’ ${g.key}</span>
        <span class="dots" onclick="groupMenu('${g.key}')">â‹®</span>
      </div>`;
    }
  });
  groupsDiv.innerHTML=h;
});

/* ===== GROUP MENU (ADMIN) ===== */
function groupMenu(group){
  db.ref("groups/"+group).once("value",snap=>{
    const d=snap.val();
    if(!d) return;

    const members=Object.keys(d.members||{});
    const isAdmin=d.owner===username;

    let text=`${group}\nğŸ‘¥ ${members.length} kiÅŸi\n\n`;
    members.forEach(m=>{
      text+=m+(m===d.owner?" (admin)":"")+"\n";
    });

    if(!isAdmin){ alert(text); return; }

    const action=prompt(
      text+
      "\nADMIN:\n"+
      "ekle = Ã¼ye ekle\n"+
      "sil = Ã¼ye Ã§Ä±kar"
    );

    if(action==="ekle"){
      const u=prompt("Eklenecek kullanÄ±cÄ± adÄ±:");
      if(u) db.ref("groups/"+group+"/members/"+u).set(true);
    }

    if(action==="sil"){
      const u=prompt("Ã‡Ä±karÄ±lacak kullanÄ±cÄ± adÄ±:");
      if(u && u!==username)
        db.ref("groups/"+group+"/members/"+u).remove();
    }
  });
}

/* ===== OPEN GROUP ===== */
function openGroup(g){
  roomInfo.innerText="ğŸ” "+g;
  chatPath="groupMessages/"+g;
  load();
}

/* ===== USERS ===== */
db.ref("users").on("value",snap=>{
  let h="<b>ğŸ‘¤ KiÅŸiler</b>";
  snap.forEach(u=>{
    if(u.key!==username){
      db.ref("status/"+u.key).once("value",st=>{
        const s=st.val();
        const info=s&&s.online
          ? `<span class="online">ğŸŸ¢ online</span>`
          : `<span class="offline">ğŸ•“ ${ago(s?.last)}</span>`;
        h+=`
        <div class="item" onclick="openDM('${u.key}')">
          ğŸ”’ ${u.key}<br>${info}
        </div>`;
        usersDiv.innerHTML=h;
      });
    }
  });
});

/* ===== DM ===== */
function openDM(u){
  const id=["dm",username,u].sort().join("_");
  roomInfo.innerText="ğŸ”’ "+u;
  chatPath="privateMessages/"+id;
  load();
}

/* ===== LOAD MSG ===== */
function load(){
  messages.innerHTML="";
  msgInput.disabled=false;
  if(msgRef) msgRef.off();
  msgRef=db.ref(chatPath);
  msgRef.limitToLast(50).on("child_added",s=>{
    const d=s.val();
    const div=document.createElement("div");
    div.className="msg"+(d.user===username?" mine":"");
    div.innerText=d.user+": "+d.text;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
  });
}

/* ===== SEND ===== */
function send(){
  if(!msgInput.value||!chatPath) return;
  db.ref(chatPath).push({
    user:username,
    text:msgInput.value,
    time:Date.now()
  });
  msgInput.value="";
}
</script>
</body>
</html>