<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg:#0b1020;
  --card:#1e1e1e;
  --text:#fff;
  --accent:#4caf50;
}
body.light{
  --bg:#f2f2f2;
  --card:#ffffff;
  --text:#000;
}
*{-webkit-tap-highlight-color:transparent;touch-action:manipulation}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Arial;
}
.app{
  max-width:420px;
  height:100vh;
  margin:auto;
  display:flex;
  flex-direction:column;
  padding:8px;
}
.card{
  background:var(--card);
  border-radius:12px;
  padding:8px;
  margin-bottom:6px;
}
.row{display:flex;justify-content:space-between;align-items:center}
.item{padding:8px;border-radius:8px;cursor:pointer}
.item:hover{background:rgba(255,255,255,.1)}
.messages{flex:1;overflow-y:auto}
.msg{
  background:#2a2a2a;
  margin:4px 0;
  padding:8px;
  border-radius:10px;
  position:relative;
}
.mine{background:var(--accent)}
.meta{font-size:10px;opacity:.7;margin-top:4px;text-align:right}
.pinned{
  background:#333;
  border-left:4px solid gold;
}
.send{display:flex;gap:6px}
input,button{border:none;border-radius:10px;padding:10px}
button{background:var(--accent);color:white}
.topbar{display:flex;justify-content:space-between;align-items:center}
</style>
</head>

<body>
<div class="app">

<div class="topbar">
  <b>ğŸ’¬ Ege Chat</b>
  <select id="themeSel">
    <option value="auto">ğŸŒ“</option>
    <option value="dark">ğŸŒ™</option>
    <option value="light">â˜€ï¸</option>
  </select>
</div>

<input id="username" placeholder="KullanÄ±cÄ± adÄ±n">

<div class="card" id="rooms"></div>

<div class="card pinned" id="pinned" style="display:none"></div>

<div class="messages" id="messages"></div>

<div class="send">
  <input id="msg" placeholder="Mesaj yaz" disabled>
  <button onclick="send()">GÃ¶nder</button>
</div>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
  databaseURL:"https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app"
});
const db=firebase.database();

/* THEME */
const themeSel=document.getElementById("themeSel");
const savedTheme=localStorage.getItem("theme")||"auto";
themeSel.value=savedTheme;
applyTheme(savedTheme);
themeSel.onchange=()=>{localStorage.setItem("theme",themeSel.value);applyTheme(themeSel.value)};
function applyTheme(t){
  document.body.className="";
  if(t==="light") document.body.classList.add("light");
  if(t==="auto" && matchMedia("(prefers-color-scheme: light)").matches)
    document.body.classList.add("light");
}

/* STATE */
let username=localStorage.getItem("ege_user")||"";
let chatPath=null, msgRef=null;

/* LOGIN */
const u=document.getElementById("username");
if(username){u.value=username;u.style.display="none";}
u.onchange=()=>{
  username=u.value.trim();
  localStorage.setItem("ege_user",username);
  u.style.display="none";
};

/* ROOMS (basit DM listesi) */
db.ref("users").on("value",snap=>{
  let h="";
  snap.forEach(s=>{
    if(s.key!==username){
      h+=`<div class="item"
        ontouchstart="openDM('${s.key}')"
        onclick="openDM('${s.key}')">ğŸ”’ ${s.key}</div>`;
    }
  });
  document.getElementById("rooms").innerHTML=h;
});

/* OPEN DM */
function openDM(u){
  chatPath=["dm",username,u].sort().join("_");
  load();
}

/* LOAD */
function load(){
  document.getElementById("messages").innerHTML="";
  document.getElementById("msg").disabled=false;

  if(msgRef) msgRef.off();
  msgRef=db.ref("chats/"+chatPath);

  msgRef.limitToLast(50).on("child_added",s=>{
    const d=s.val();
    if(!d.seenBy) d.seenBy={};
    d.seenBy[username]=true;
    db.ref("chats/"+chatPath+"/"+s.key+"/seenBy/"+username).set(true);

    renderMsg(s.key,d);
  });

  db.ref("pinned/"+chatPath).on("value",s=>{
    const p=document.getElementById("pinned");
    if(s.exists()){
      p.style.display="block";
      p.innerText="ğŸ“Œ "+s.val().text;
    }else p.style.display="none";
  });
}

/* RENDER */
function renderMsg(id,d){
  const div=document.createElement("div");
  div.className="msg"+(d.user===username?" mine":"");
  div.innerHTML=`
    <b>${d.user}</b><br>${d.text}
    <div class="meta">
      ${Object.keys(d.seenBy||{}).length>1?"âœ“âœ“":"âœ“"}
      <span onclick="pin('${id}','${d.text}')">ğŸ“Œ</span>
    </div>`;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
}

/* SEND */
function send(){
  const t=msg.value.trim();
  if(!t||!chatPath) return;
  db.ref("chats/"+chatPath).push({
    user:username,
    text:t,
    time:Date.now(),
    seenBy:{[username]:true}
  });
  msg.value="";
}

/* PIN */
function pin(id,text){
  if(confirm("Mesaj sabitlensin mi?")){
    db.ref("pinned/"+chatPath).set({id,text});
  }
}
</script>
</body>
</html>