<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#121212;color:white;font-family:Arial}
.chat{max-width:420px;height:100vh;margin:auto;background:#1e1e1e;display:flex;flex-direction:column;padding:10px}
h3{text-align:center;margin:5px 0}
.section{background:#2a2a2a;padding:6px;border-radius:6px;margin-bottom:5px;font-size:13px}
.item{padding:6px;cursor:pointer;border-radius:5px}
.item:hover{background:#3a3a3a}
.messages{flex:1;overflow-y:auto;margin:5px 0}
.msg{background:#333;padding:8px;border-radius:8px;margin:4px 0}
.send{display:flex;gap:5px}
input,button{padding:10px;border:none;border-radius:8px}
input{flex:1}
button{background:#4caf50;color:white}
.room{text-align:center;font-size:13px;color:#ccc;margin:5px 0;cursor:pointer}
.small{font-size:11px;color:#aaa}
</style>
</head>

<body>
<div class="chat">
<h3>ğŸ’¬ Ege Chat</h3>

<input id="username" placeholder="KullanÄ±cÄ± adÄ±n">

<div class="section">
  <input id="newRoom" placeholder="â• Oda adÄ±">
  <input id="roomPass" placeholder="ğŸ” Åifre (opsiyonel)">
  <button onclick="createRoom()">OluÅŸtur</button>
</div>

<div class="section" id="rooms"><b>ğŸ  Odalar</b></div>
<div class="section" id="users"><b>ğŸ‘¤ KiÅŸiler</b></div>

<div class="room" id="roomName">ğŸŒ Genel Sohbet</div>
<div class="small" id="roomInfo"></div>

<div class="messages" id="messages"></div>

<div class="send">
  <input id="message" placeholder="Mesaj yaz">
  <button onclick="sendMessage()">GÃ¶nder</button>
</div>
</div>

<script>
/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
  authDomain: "chat-lobby-fa938.firebaseapp.com",
  databaseURL: "https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-lobby-fa938",
  storageBucket: "chat-lobby-fa938.firebasestorage.app",
  messagingSenderId: "436067349066",
  appId: "1:436067349066:web:65f19c754697b6f84d6cb3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ELEMENTLER */
const userInput = document.getElementById("username");
const roomsDiv = document.getElementById("rooms");
const usersDiv = document.getElementById("users");
const messages = document.getElementById("messages");
const msgInput = document.getElementById("message");
const roomName = document.getElementById("roomName");
const roomInfo = document.getElementById("roomInfo");
const newRoomInput = document.getElementById("newRoom");
const roomPassInput = document.getElementById("roomPass");

/* DURUM */
let username = localStorage.getItem("egechat_username") || "";
let currentChat = "public";
let currentRoom = null;
let msgRef;

/* GÄ°RÄ°Å */
if(username){
  userInput.value=username;
  userInput.style.display="none";
  db.ref("users/"+username).set(true);
  loadMessages();
}

userInput.addEventListener("change",()=>{
  username=userInput.value.trim();
  if(!username) return;
  localStorage.setItem("egechat_username",username);
  userInput.style.display="none";
  db.ref("users/"+username).set(true);
  loadMessages();
});

/* 1ï¸âƒ£ ÅÄ°FRELÄ° + SAHÄ°PLÄ° ODA OLUÅTUR */
function createRoom(){
  const room=newRoomInput.value.trim();
  if(!room) return;

  db.ref("rooms/"+room).set({
    owner: username,
    password: roomPassInput.value || "",
    created: Date.now()
  });

  newRoomInput.value="";
  roomPassInput.value="";
}

/* ODA LÄ°STESÄ° */
db.ref("rooms").on("value",snap=>{
  let html="<b>ğŸ  Odalar</b>";
  snap.forEach(r=>{
    html+=`<div class="item" onclick="enterRoom('${r.key}')"># ${r.key}</div>`;
  });
  roomsDiv.innerHTML=html;
});

/* ODAYA GÄ°R (ÅÄ°FRE KONTROL) */
function enterRoom(room){
  db.ref("rooms/"+room).once("value",snap=>{
    const data=snap.val();
    if(data.password){
      const p=prompt("Oda ÅŸifresi:");
      if(p!==data.password) return alert("âŒ YanlÄ±ÅŸ ÅŸifre");
    }
    openRoom(room,data.owner);
  });
}

/* ODA AÃ‡ */
function openRoom(room,owner){
  currentRoom=room;
  currentChat="room_"+room;
  roomName.innerText="ğŸ  "+room;
  roomInfo.innerText="ğŸ‘‘ Sahip: "+owner+" | ğŸ‘¥ Online: yÃ¼kleniyor...";
  messages.innerHTML="";
  loadMessages();
  updateOnlineCount();
}

/* 5ï¸âƒ£ ONLINE SAYISI */
function updateOnlineCount(){
  const ref=db.ref("roomOnline/"+currentRoom+"/"+username);
  ref.set(true);
  ref.onDisconnect().remove();

  db.ref("roomOnline/"+currentRoom).on("value",snap=>{
    roomInfo.innerText=roomInfo.innerText.split("|")[0]+" | ğŸ‘¥ Online: "+snap.numChildren();
  });
}

/* KÄ°ÅÄ°LER */
db.ref("users").on("value",snap=>{
  let html="<b>ğŸ‘¤ KiÅŸiler</b>";
  snap.forEach(u=>{
    if(u.key!==username){
      html+=`<div class="item" onclick="openPrivate('${u.key}')">ğŸ”’ ${u.key}</div>`;
    }
  });
  usersDiv.innerHTML=html;
});

/* Ã–ZEL SOHBET */
function openPrivate(other){
  currentChat=["dm",username,other].sort().join("|");
  currentRoom=null;
  roomName.innerText="ğŸ”’ "+other+" ile Ã¶zel sohbet";
  roomInfo.innerText="";
  messages.innerHTML="";
  loadMessages();
}

/* GENEL */
roomName.onclick=()=>{
  currentChat="public";
  currentRoom=null;
  roomName.innerText="ğŸŒ Genel Sohbet";
  roomInfo.innerText="";
  messages.innerHTML="";
  loadMessages();
}

/* MESAJLAR */
function loadMessages(){
  if(msgRef) msgRef.off();

  let path="messages";
  if(currentChat.startsWith("room_")) path="roomsMessages/"+currentChat;
  if(currentChat.includes("|")) path="privateMessages/"+currentChat;

  msgRef=db.ref(path);
  msgRef.limitToLast(50).on("child_added",snap=>{
    const d=snap.val();
    const div=document.createElement("div");
    div.className="msg";
    div.innerText=d.user+": "+d.text;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
  });
}

/* GÃ–NDER */
function sendMessage(){
  if(!msgInput.value.trim()) return;

  let path="messages";
  if(currentChat.startsWith("room_")) path="roomsMessages/"+currentChat;
  if(currentChat.includes("|")) path="privateMessages/"+currentChat;

  db.ref(path).push({
    user:username,
    text:msgInput.value,
    time:Date.now()
  });

  msgInput.value="";
}
</script>
</body>
</html>