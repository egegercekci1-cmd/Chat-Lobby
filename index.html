<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#121212;color:white;font-family:Arial}
.chat{max-width:420px;height:100vh;margin:auto;background:#1e1e1e;display:flex;flex-direction:column;padding:10px}
.section{background:#2a2a2a;padding:6px;border-radius:6px;margin-bottom:6px;font-size:13px}
.item{padding:6px;border-radius:5px;cursor:pointer}
.item:hover{background:#3a3a3a}
.messages{flex:1;overflow-y:auto}
.msg{background:#333;padding:8px;border-radius:8px;margin:4px 0}
.replyBox{font-size:11px;color:#aaa;border-left:3px solid #4caf50;padding-left:5px;margin-bottom:4px}
.status{font-size:10px;color:#aaa;text-align:right}
.typing{font-size:11px;color:#4caf50}
.admin{color:#4caf50;cursor:pointer}
</style>
</head>

<body>
<div class="chat">
<h3 style="text-align:center">ğŸ’¬ Ege Chat</h3>

<input id="username" placeholder="KullanÄ±cÄ± adÄ±n">

<div class="section">
<input id="newGroup" placeholder="â• Grup adÄ±">
<button onclick="createGroup()">OluÅŸtur</button>
</div>

<div class="section" id="groups"></div>
<div class="section" id="users"></div>

<div id="roomName">ğŸ“Œ Lobi</div>
<div id="roomInfo" class="typing"></div>

<div class="messages" id="messages"></div>

<div id="replyPreview"></div>

<div style="display:flex">
<input id="message" placeholder="Mesaj yaz" disabled>
<button onclick="sendMessage()" id="sendBtn" disabled>GÃ¶nder</button>
</div>
</div>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
 databaseURL:"https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let username=localStorage.getItem("user")||"";
let currentChat=null,currentGroup=null,replyTo=null;

const userInput=document.getElementById("username");
if(username){
 userInput.value=username;
 userInput.style.display="none";
 db.ref("users/"+username).set(true);
}
userInput.onchange=()=>{
 username=userInput.value;
 localStorage.setItem("user",username);
 userInput.style.display="none";
 db.ref("users/"+username).set(true);
};

function createGroup(){
 const g=newGroup.value;
 db.ref("groups/"+g).set({
  owner:username,
  desc:"",
  members:{[username]:true}
 });
}

db.ref("groups").on("value",s=>{
 let h="<b>ğŸ” Gruplar</b>";
 s.forEach(g=>{
  if(g.val().members?.[username])
   h+=`<div class="item" onclick="openGroup('${g.key}')">${g.key}</div>`;
 });
 groups.innerHTML=h;
});

function openGroup(g){
 currentGroup=g;
 currentChat="group_"+g;
 loadMessages();
 setupTyping();
}

db.ref("users").on("value",s=>{
 let h="<b>ğŸ‘¤ KiÅŸiler</b>";
 s.forEach(u=>{
  if(u.key!==username)
   h+=`<div class="item" onclick="openDM('${u.key}')">${u.key}</div>`;
 });
 users.innerHTML=h;
});

function openDM(u){
 currentChat=["dm",username,u].sort().join("|");
 currentGroup=null;
 loadMessages();
 setupTyping();
}

function setupTyping(){
 message.disabled=false;
 sendBtn.disabled=false;
 message.oninput=()=>{
  db.ref("typing/"+currentChat+"/"+username).set(true);
  setTimeout(()=>db.ref("typing/"+currentChat+"/"+username).remove(),1000);
 };
 db.ref("typing/"+currentChat).on("value",s=>{
  let names=[];
  s.forEach(x=>{if(x.key!==username)names.push(x.key)});
  roomInfo.innerText=names.length?names.join(", ")+" yazÄ±yorâ€¦":"";
 });
}

function loadMessages(){
 messages.innerHTML="";
 let path=currentGroup?"groupMessages/"+currentGroup:"privateMessages/"+currentChat;
 db.ref(path).off();
 db.ref(path).on("child_added",s=>{
  const d=s.val();
  const div=document.createElement("div");
  div.className="msg";
  div.oncontextmenu=e=>{
   e.preventDefault();
   replyTo=d;
   replyPreview.innerHTML=`YanÄ±tlanÄ±yor: ${d.text}`;
  };
  if(d.reply)
   div.innerHTML=`<div class="replyBox">${d.reply.user}: ${d.reply.text}</div>`;
  div.innerHTML+=`${d.user}: ${d.text}`;
  if(d.user===username)
   div.innerHTML+=`<div class="status">${d.read?"âœ”âœ”":"âœ”"}</div>`;
  messages.appendChild(div);
  db.ref(path+"/"+s.key+"/read").set(true);
 });
}

function sendMessage(){
 let path=currentGroup?"groupMessages/"+currentGroup:"privateMessages/"+currentChat;
 db.ref(path).push({
  user:username,
  text:message.value,
  reply:replyTo?{user:replyTo.user,text:replyTo.text}:null,
  read:false,
  time:Date.now()
 });
 replyTo=null;
 replyPreview.innerHTML="";
 message.value="";
}
</script>
</body>
</html>