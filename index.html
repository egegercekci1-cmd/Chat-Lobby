<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#121212;color:white;font-family:Arial}
.chat{max-width:420px;height:100vh;margin:auto;background:#1e1e1e;display:flex;flex-direction:column;padding:10px}
h3{text-align:center;margin:5px 0}
.section{background:#2a2a2a;padding:6px;border-radius:6px;margin-bottom:6px;font-size:13px}
.item{padding:6px;border-radius:5px;cursor:pointer}
.item:hover{background:#3a3a3a}
.small{font-size:11px;color:#aaa}
.online{color:#4caf50;font-size:11px}
.offline{color:#aaa;font-size:11px}
.messages{flex:1;overflow-y:auto}
.msg{background:#333;padding:8px;border-radius:8px;margin:4px 0}
.replyBox{font-size:11px;color:#aaa;border-left:3px solid #4caf50;padding-left:5px;margin-bottom:4px}
.status{font-size:10px;color:#aaa;text-align:right}
.typing{font-size:11px;color:#4caf50}
.group-item{display:flex;justify-content:space-between;align-items:center}
.dots{padding:4px 8px;font-size:18px;color:#aaa;cursor:pointer}
.dots:hover{color:white}
.admin{color:#4caf50;cursor:pointer;margin-left:6px}
.send{display:flex;gap:5px}
input,button{padding:10px;border:none;border-radius:8px}
input{flex:1}
button{background:#4caf50;color:white}
</style>
</head>

<body>
<div class="chat">
<h3>ğŸ’¬ Ege Chat</h3>

<input id="username" placeholder="KullanÄ±cÄ± adÄ±n">

<div class="section">
  <input id="newGroup" placeholder="â• Grup adÄ±">
  <button onclick="createGroup()">Grup OluÅŸtur</button>
</div>

<div class="section" id="groups"><b>ğŸ” GruplarÄ±m</b></div>
<div class="section" id="users"><b>ğŸ‘¤ KiÅŸiler</b></div>

<div class="small" id="roomInfo">ğŸ“Œ Lobi</div>

<div class="messages" id="messages"></div>

<div id="replyPreview" class="small"></div>

<div class="send">
  <input id="message" placeholder="Mesaj yaz" disabled>
  <button id="sendBtn" onclick="sendMessage()" disabled>GÃ¶nder</button>
</div>
</div>

<script>
/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
  authDomain: "chat-lobby-fa938.firebaseapp.com",
  databaseURL: "https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-lobby-fa938"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ELEMENTLER */
const userInput = document.getElementById("username");
const groupsDiv = document.getElementById("groups");
const usersDiv = document.getElementById("users");
const messages = document.getElementById("messages");
const msgInput = document.getElementById("message");
const sendBtn = document.getElementById("sendBtn");
const roomInfo = document.getElementById("roomInfo");
const newGroupInput = document.getElementById("newGroup");
const replyPreview = document.getElementById("replyPreview");

/* DURUM */
let username = localStorage.getItem("egechat_user") || "";
let currentChat = null;
let currentGroup = null;
let replyTo = null;
let msgRef = null;

/* ZAMAN */
function timeAgo(t){
  if(!t) return "bilinmiyor";
  const d = Math.floor((Date.now()-t)/1000);
  if(d<60) return "az Ã¶nce";
  if(d<3600) return Math.floor(d/60)+" dk Ã¶nce";
  if(d<86400) return Math.floor(d/3600)+" saat Ã¶nce";
  return new Date(t).toLocaleString("tr-TR");
}

/* ONLINE DURUM */
function setOnlineStatus(){
  const ref = db.ref("status/"+username);
  ref.set({online:true,lastSeen:Date.now()});
  ref.onDisconnect().set({online:false,lastSeen:Date.now()});
}

/* GÄ°RÄ°Å */
if(username){
  userInput.value=username;
  userInput.style.display="none";
  db.ref("users/"+username).set(true);
  setOnlineStatus();
}

userInput.onchange=()=>{
  username=userInput.value.trim();
  if(!username) return;
  localStorage.setItem("egechat_user",username);
  userInput.style.display="none";
  db.ref("users/"+username).set(true);
  setOnlineStatus();
};

/* GRUP OLUÅTUR */
function createGroup(){
  const g=newGroupInput.value.trim();
  if(!g) return;
  db.ref("groups/"+g).set({
    owner:username,
    members:{[username]:true}
  });
  newGroupInput.value="";
}

/* GRUP LÄ°STESÄ° */
db.ref("groups").on("value",snap=>{
  let html="<b>ğŸ” GruplarÄ±m</b>";
  snap.forEach(g=>{
    if(g.val().members && g.val().members[username]){
      html+=`
      <div class="item group-item">
        <span onclick="openGroup('${g.key}')">ğŸ”’ ${g.key}</span>
        <span class="dots" onclick="event.stopPropagation();showGroupInfo('${g.key}')">â‹®</span>
      </div>`;
    }
  });
  groupsDiv.innerHTML=html;
});

/* â‹® GRUP BÄ°LGÄ° */
function showGroupInfo(g){
  db.ref("groups/"+g).once("value",s=>{
    const d=s.val();
    if(!d) return;
    const m=Object.keys(d.members||{});
    let txt=`ğŸ‘¥ Ãœye SayÄ±sÄ±: ${m.length}\n\n`;
    m.forEach(u=>{
      txt+=u===d.owner?`â€¢ ${u} (admin)\n`:`â€¢ ${u}\n`;
    });
    alert("ğŸ” "+g+"\n\n"+txt);
  });
}

/* GRUP AÃ‡ */
function openGroup(g){
  currentGroup=g;
  currentChat="group_"+g;
  messages.innerHTML="";
  msgInput.disabled=false;
  sendBtn.disabled=false;
  roomInfo.innerText="ğŸ” "+g;
  loadMessages();
}

/* KÄ°ÅÄ°LER + ONLINE */
db.ref("users").on("value",snap=>{
  let html="<b>ğŸ‘¤ KiÅŸiler</b>";
  snap.forEach(u=>{
    if(u.key!==username){
      db.ref("status/"+u.key).once("value",st=>{
        const s=st.val();
        let info=`<span class="offline">ğŸ•“ bilinmiyor</span>`;
        if(s){
          info=s.online
            ? `<span class="online">ğŸŸ¢ online</span>`
            : `<span class="offline">ğŸ•“ ${timeAgo(s.lastSeen)}</span>`;
        }
        html+=`
        <div class="item" onclick="openPrivate('${u.key}')">
          ğŸ”’ ${u.key}<br>${info}
        </div>`;
        usersDiv.innerHTML=html;
      });
    }
  });
});

/* DM */
function openPrivate(u){
  currentChat=["dm",username,u].sort().join("|");
  currentGroup=null;
  messages.innerHTML="";
  msgInput.disabled=false;
  sendBtn.disabled=false;
  roomInfo.innerText="ğŸ”’ "+u;
  loadMessages();
}

/* MESAJLAR */
function loadMessages(){
  if(msgRef) msgRef.off();
  let path=currentGroup
    ? "groupMessages/"+currentGroup
    : "privateMessages/"+currentChat;

  msgRef=db.ref(path);
  msgRef.limitToLast(50).on("child_added",s=>{
    const d=s.val();
    const div=document.createElement("div");
    div.className="msg";
    div.oncontextmenu=e=>{
      e.preventDefault();
      replyTo=d;
      replyPreview.innerText="YanÄ±tlanÄ±yor: "+d.text;
    };
    if(d.reply){
      div.innerHTML=`<div class="replyBox">${d.reply.user}: ${d.reply.text}</div>`;
    }
    div.innerHTML+=`${d.user}: ${d.text}`;
    if(d.user===username){
      div.innerHTML+=`<div class="status">${d.read?"âœ”âœ”":"âœ”"}</div>`;
    }
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
    if(d.user!==username){
      db.ref(path+"/"+s.key+"/read").set(true);
    }
  });
}

/* GÃ–NDER */
function sendMessage(){
  if(!msgInput.value.trim()) return;
  let path=currentGroup
    ? "groupMessages/"+currentGroup
    : "privateMessages/"+currentChat;

  db.ref(path).push({
    user:username,
    text:msgInput.value,
    reply:replyTo?{user:replyTo.user,text:replyTo.text}:null,
    read:false,
    time:Date.now()
  });
  replyTo=null;
  replyPreview.innerText="";
  msgInput.value="";
}
</script>
</body>
</html>