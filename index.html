<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#121212;color:white;font-family:Arial}
.chat{max-width:420px;height:100vh;margin:auto;background:#1e1e1e;display:flex;flex-direction:column;padding:10px}
h3{text-align:center;margin:5px 0}
.section{background:#2a2a2a;padding:6px;border-radius:6px;margin-bottom:6px;font-size:13px}
.item{padding:6px;border-radius:5px;cursor:pointer}
.item:hover{background:#3a3a3a}
.group-item{display:flex;justify-content:space-between;align-items:center}
.dots{padding:4px 8px;font-size:18px;color:#aaa;cursor:pointer}
.dots:hover{color:white}
.messages{flex:1;overflow-y:auto;margin:5px 0}
.msg{background:#333;padding:8px;border-radius:8px;margin:4px 0}
.send{display:flex;gap:5px}
input,button{padding:10px;border:none;border-radius:8px}
input{flex:1}
button{background:#4caf50;color:white}
.room{text-align:center;font-size:13px;color:#ccc;margin:5px 0}
.small{font-size:11px;color:#aaa}
.admin{color:#4caf50;cursor:pointer;margin-left:6px}
</style>
</head>

<body>
<div class="chat">
<h3>ğŸ’¬ Ege Chat</h3>

<input id="username" placeholder="KullanÄ±cÄ± adÄ±n">

<div class="section">
  <input id="newGroup" placeholder="â• Grup adÄ±">
  <button onclick="createGroup()">Grup OluÅŸtur</button>
</div>

<div class="section" id="groups"><b>ğŸ” GruplarÄ±m</b></div>
<div class="section" id="users"><b>ğŸ‘¤ KiÅŸiler</b></div>

<div class="room" id="roomName">ğŸ“Œ Lobi</div>
<div class="small" id="roomInfo">Bir grup veya kiÅŸi seÃ§</div>

<div class="messages" id="messages"></div>

<div class="send">
  <input id="message" placeholder="Mesaj yaz" disabled>
  <button id="sendBtn" onclick="sendMessage()" disabled>GÃ¶nder</button>
</div>
</div>

<script>
/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
  authDomain: "chat-lobby-fa938.firebaseapp.com",
  databaseURL: "https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-lobby-fa938",
  storageBucket: "chat-lobby-fa938.firebasestorage.app",
  messagingSenderId: "436067349066",
  appId: "1:436067349066:web:65f19c754697b6f84d6cb3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ELEMENTLER */
const userInput = document.getElementById("username");
const groupsDiv = document.getElementById("groups");
const usersDiv = document.getElementById("users");
const messages = document.getElementById("messages");
const msgInput = document.getElementById("message");
const sendBtn = document.getElementById("sendBtn");
const roomName = document.getElementById("roomName");
const roomInfo = document.getElementById("roomInfo");
const newGroupInput = document.getElementById("newGroup");

/* DURUM */
let username = localStorage.getItem("egechat_username") || "";
let currentChat = null;
let currentGroup = null;
let msgRef = null;

/* GÄ°RÄ°Å */
if(username){
  userInput.value = username;
  userInput.style.display = "none";
  db.ref("users/"+username).set(true);
}

userInput.addEventListener("change",()=>{
  username = userInput.value.trim();
  if(!username) return;
  localStorage.setItem("egechat_username",username);
  userInput.style.display="none";
  db.ref("users/"+username).set(true);
});

/* GRUP OLUÅTUR */
function createGroup(){
  const g = newGroupInput.value.trim();
  if(!g) return;
  db.ref("groups/"+g).set({
    owner: username,
    members:{ [username]: true }
  });
  newGroupInput.value="";
}

/* GRUP LÄ°STESÄ° */
db.ref("groups").on("value",snap=>{
  let html="<b>ğŸ” GruplarÄ±m</b>";
  snap.forEach(g=>{
    if(g.val().members && g.val().members[username]){
      html += `
      <div class="item group-item">
        <span onclick="openGroup('${g.key}')">ğŸ”’ ${g.key}</span>
        <span class="dots" onclick="event.stopPropagation();showGroupInfo('${g.key}')">â‹®</span>
      </div>`;
    }
  });
  groupsDiv.innerHTML = html;
});

/* GRUP AÃ‡ */
function openGroup(g){
  currentGroup = g;
  currentChat = "group_"+g;
  roomName.innerText = "ğŸ” "+g;
  roomInfo.innerText = "";
  messages.innerHTML = "";
  msgInput.disabled = false;
  sendBtn.disabled = false;
  loadMessages();
  updateGroupOnline();
  showAdminControls();
}

/* â‹® GRUP BÄ°LGÄ° */
function showGroupInfo(group){
  db.ref("groups/"+group).once("value",snap=>{
    const d = snap.val();
    if(!d || !d.members) return;
    const members = Object.keys(d.members);
    let text = `ğŸ‘¥ Ãœye SayÄ±sÄ±: ${members.length}\n\n`;
    members.forEach(m=>{
      text += m===d.owner ? `â€¢ ${m} (admin)\n` : `â€¢ ${m}\n`;
    });
    alert("ğŸ” "+group+"\n\n"+text);
  });
}

/* ADMIN */
function showAdminControls(){
  db.ref("groups/"+currentGroup+"/owner").once("value",snap=>{
    if(snap.val()===username){
      roomInfo.innerHTML =
        'ğŸ‘‘ Admin | <span class="admin" onclick="addMember()">â• Ekle</span>' +
        ' <span class="admin" onclick="removeMember()">â– Ã‡Ä±kar</span>';
    }
  });
}

function addMember(){
  const u = prompt("Eklenecek kullanÄ±cÄ±:");
  if(!u) return;
  db.ref("groups/"+currentGroup+"/members/"+u).set(true);
}

function removeMember(){
  const u = prompt("Ã‡Ä±karÄ±lacak kullanÄ±cÄ±:");
  if(!u || u===username) return;
  db.ref("groups/"+currentGroup+"/members/"+u).remove();
}

/* GRUP ONLINE */
function updateGroupOnline(){
  const ref = db.ref("groupOnline/"+currentGroup+"/"+username);
  ref.set(true);
  ref.onDisconnect().remove();

  db.ref("groupOnline/"+currentGroup).on("value",snap=>{
    roomInfo.innerHTML = "ğŸ‘¥ Online: "+snap.numChildren()+roomInfo.innerHTML.replace(/.*\|/,"");
  });
}

/* KÄ°ÅÄ°LER (DM) */
db.ref("users").on("value",snap=>{
  let html="<b>ğŸ‘¤ KiÅŸiler</b>";
  snap.forEach(u=>{
    if(u.key!==username){
      html+=`<div class="item" onclick="openPrivate('${u.key}')">ğŸ”’ ${u.key}</div>`;
    }
  });
  usersDiv.innerHTML=html;
});

/* DM */
function openPrivate(other){
  currentChat = ["dm",username,other].sort().join("|");
  currentGroup = null;
  roomName.innerText = "ğŸ”’ "+other;
  roomInfo.innerText = "";
  messages.innerHTML = "";
  msgInput.disabled = false;
  sendBtn.disabled = false;
  loadMessages();
}

/* MESAJLAR */
function loadMessages(){
  if(msgRef) msgRef.off();
  let path = currentChat.startsWith("group_")
    ? "groupMessages/"+currentGroup
    : "privateMessages/"+currentChat;

  msgRef = db.ref(path);
  msgRef.limitToLast(50).on("child_added",snap=>{
    const d = snap.val();
    const div = document.createElement("div");
    div.className="msg";
    div.innerText = d.user+": "+d.text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  });
}

/* GÃ–NDER */
function sendMessage(){
  if(!msgInput.value.trim()) return;
  let path = currentChat.startsWith("group_")
    ? "groupMessages/"+currentGroup
    : "privateMessages/"+currentChat;

  db.ref(path).push({
    user: username,
    text: msgInput.value,
    time: Date.now()
  });
  msgInput.value="";
}
</script>
</body>
</html>