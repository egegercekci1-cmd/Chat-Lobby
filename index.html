<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Ege Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#121212;
  color:white;
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.chat{
  width:360px;
  height:600px;
  background:#1e1e1e;
  border-radius:12px;
  padding:10px;
  display:flex;
  flex-direction:column;
}
h3{
  margin:5px 0;
  text-align:center;
}
.status{
  font-size:12px;
  color:#aaa;
  white-space:pre-line;
}
.messages{
  flex:1;
  overflow-y:auto;
  margin:10px 0;
}
.msg{
  background:#333;
  padding:6px 8px;
  border-radius:8px;
  margin:4px 0;
  font-size:14px;
}
.send{
  display:flex;
  gap:5px;
}
input,button{
  padding:8px;
  border:none;
  border-radius:6px;
}
input{
  flex:1;
}
button{
  background:#4caf50;
  color:white;
}
</style>
</head>
<body>

<audio id="notifySound" src="https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3"></audio>

<div class="chat">
  <h3>üí¨ Ege Chat</h3>

  <div class="status" id="onlineStatus"></div>
  <div class="status" id="typingStatus"></div>

  <input id="username" placeholder="Kullanƒ±cƒ± adƒ±n">
  <div class="messages" id="messages"></div>

  <div class="send">
    <input id="message" placeholder="Mesaj yaz">
    <button onclick="sendMessage()">G√∂nder</button>
  </div>
</div>

<script>
/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCDJ3x--j0YFqOZxz1Wj-o5_QLn9KgJlnk",
  authDomain: "chat-lobby-fa938.firebaseapp.com",
  databaseURL: "https://chat-lobby-fa938-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-lobby-fa938",
  storageBucket: "chat-lobby-fa938.firebasestorage.app",
  messagingSenderId: "436067349066",
  appId: "1:436067349066:web:65f19c754697b6f84d6cb3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const userInput = document.getElementById("username");
const msgInput = document.getElementById("message");
const messages = document.getElementById("messages");
const onlineStatus = document.getElementById("onlineStatus");
const typingStatus = document.getElementById("typingStatus");
const sound = document.getElementById("notifySound");

let username = "";

/* üë§ KULLANICI ADI */
userInput.addEventListener("change", () => {
  username = userInput.value.trim();
  if(username) setOnline(true);
});

/* üü¢ ONLINE / üî¥ OFFLINE + SON G√ñR√úLME */
function setOnline(state){
  if(!username) return;

  const ref = db.ref("status/" + username);

  if(state){
    ref.set({ online:true, lastSeen:Date.now() });
    ref.onDisconnect().set({ online:false, lastSeen:Date.now() });
  } else {
    ref.set({ online:false, lastSeen:Date.now() });
  }
}

/* ‚úçÔ∏è YAZIYOR */
msgInput.addEventListener("input", () => {
  if(!username) return;
  db.ref("typing/" + username).set(true);

  clearTimeout(window.typingTimer);
  window.typingTimer = setTimeout(() => {
    db.ref("typing/" + username).set(false);
  }, 1000);
});

/* üì© MESAJ G√ñNDER */
function sendMessage(){
  if(!username || !msgInput.value.trim()) return;

  db.ref("messages").push({
    user: username,
    text: msgInput.value,
    time: Date.now()
  });

  db.ref("typing/" + username).set(false);
  msgInput.value = "";
}

/* üì• MESAJLARI Dƒ∞NLE + üîî SES */
db.ref("messages").on("child_added", snap => {
  const d = snap.val();
  const div = document.createElement("div");
  div.className = "msg";
  div.innerText = d.user + ": " + d.text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;

  if(d.user !== username){
    sound.play().catch(()=>{});
  }
});

/* üë• ONLINE + SON G√ñR√úLME G√ñSTER */
db.ref("status").on("value", snap => {
  let text = "";
  snap.forEach(u => {
    const d = u.val();
    if(d.online){
      text += "üü¢ " + u.key + " online\n";
    } else if(d.lastSeen){
      text += "‚ö´ " + u.key + " son g√∂r√ºlme: " + timeAgo(d.lastSeen) + "\n";
    }
  });
  onlineStatus.innerText = text || "Kimse yok";
});

/* ‚úçÔ∏è YAZIYOR G√ñSTER */
db.ref("typing").on("value", snap => {
  let arr = [];
  snap.forEach(u => {
    if(u.val() && u.key !== username) arr.push(u.key);
  });
  typingStatus.innerText = arr.length ? "‚úçÔ∏è " + arr.join(", ") + " yazƒ±yor..." : "";
});

/* ‚è±Ô∏è ZAMAN HESABI */
function timeAgo(t){
  const s = Math.floor((Date.now()-t)/1000);
  if(s<60) return s+" sn √∂nce";
  if(s<3600) return Math.floor(s/60)+" dk √∂nce";
  if(s<86400) return Math.floor(s/3600)+" saat √∂nce";
  return Math.floor(s/86400)+" g√ºn √∂nce";
}
</script>

</body>
</html>